# پردازش پس‌زمینه‌ی مدارک کاربران

![Difficulty](https://img.shields.io/badge/difficulty-medium-brightgreen)
![Languages](https://img.shields.io/badge/languages-C%23-informational)
![Deadline](https://img.shields.io/badge/deadline-2025--12--07-critical)

> یک سامانه کوچک مدیریت کاربران بسازید که با استفاده از **Jobهای پس‌زمینه**، مدارک آپلود‌شده را پردازش کند، پیام‌های اطلاع‌رسانی ارسال کند، هر شب عملیات پاکسازی انجام دهد و مکانیزم Retry داشته باشد — بدون اینکه API اصلی بلاک یا کند شود.

---

## فهرست مطالب

* [نیازمندی‌ها](#نیازمندیها)
* [شرح مسئله](#شرح-مسئله)
* [قوانین و محدودیت‌ها](#قوانین-و-محدودیتها)
* [سناریوهای کلیدی](#سناریوهای-کلیدی)
* [مثال ورودی/خروجی](#مثال-ورودیاخروجی)
* [روش اجرا و تست](#روش-اجرا-و-تست)
* [نحوه ارسال (PR)](#نحوه-ارسال-pr)
* [معیارهای ارزیابی](#معیارهای-ارزیابی)
* [زمان‌بندی](#زمانبندی)
* [ارتباط](#ارتباط)

---

## نیازمندی‌ها

* زبان مجاز: **C#**
* نسخه پیشنهادی: `.NET 6+`
* سیستم‌عامل: Windows / Linux / macOS
* استفاده از کتابخانه‌های زیر مجاز است:

  * **Hangfire (توصیه‌شده)**
  * Quartz.NET
  * BackgroundService با زمان‌بندی سفارشی
* آشنایی با:

  * طراحی APIهای REST
  * پردازش پس‌زمینه و صف‌ها
  * مکانیزم Retry
  * مدیریت فایل

---

## شرح مسئله

یک **سامانه مدیریت کاربران** باید طراحی کنید که در آن کاربر هنگام ثبت‌نام، یک **فایل مدرک** آپلود می‌کند. سیستم باید مراحل زیر را انجام دهد:

1. ثبت‌نام کاربر + ذخیره فایل
2. **بازگشت فوری پاسخ** بدون صبر برای پردازش
3. اجرای Jobهای پس‌زمینه:

   * ارسال پیام خوش‌آمدگویی بلافاصله بعد از ثبت‌نام
   * پردازش فایل پس از **۳۰ ثانیه تأخیر** و تبدیل به PDF (شبیه‌سازی مجاز)
   * ارسال پیام تکمیلی بعد از پایان پردازش
   * اجرای Job پاکسازی هر شب رأس **۰۰:۰۰**
4. اعمال سیاست Retry:

   * حداکثر **۲ بار Retry**
   * Retry اول → پس از **۵ دقیقه**
   * Retry دوم → پس از **۱۰ دقیقه**
5. API اصلی نباید تحت تأثیر عملیات سنگین قرار گیرد.

هدف: پیاده‌سازی سیستمی تمیز، قابل نگهداری و استاندارد.

---

## قوانین و محدودیت‌ها

* Endpoint ثبت‌نام باید:

  * اطلاعات کاربر و فایل را ذخیره کند
  * Jobها را در صف قرار دهد
  * **فوراً** پاسخ دهد (`201 Created`)
* تأخیر ۳۰ثانیه باید با **Delayed Job** پیاده‌سازی شود (نه Thread.Sleep).
* پاکسازی شبانه باید با **Recurring Job** انجام شود.
* تبدیل PDF می‌تواند کاملاً شبیه‌سازی شود.
* Retry باید توسط خود سیستم Job انجام شود.
* کد باید تمیز، ماژولار و با قابلیت نگهداری باشد.

---

## سناریوهای کلیدی

### ۱. API ثبت‌نام کاربر

* آدرس: `POST /api/users/register`
* ورودی:

  * نام، ایمیل
  * فایل مدرک
* رفتار:

  1. ذخیره اطلاعات
  2. ثبت Job فوری → پیام خوش‌آمدگویی
  3. ثبت Job با تأخیر ۳۰ ثانیه → پردازش فایل
  4. بازگشت پاسخ سریع

---

### ۲. Job پیام خوش‌آمدگویی

* اجرا بلافاصله پس از ثبت‌نام
* لاگ یا پیام:  «کاربر عزیز، خوش آمدید!»
* نباید API را بلاک کند

---

### ۳. Job پردازش فایل (۳۰ثانیه)

* دریافت اطلاعات فایل
* تبدیل به PDF (شبیه‌سازی)
* تغییر وضعیت به `Processed`
* ثبت Job پیام تکمیلی

---

### ۴. Job پیام تکمیلی

پیام:

> «مدرک شما با موفقیت پردازش شد.»

---

### ۵. Job پاکسازی شبانه (۰۰:۰۰)

* اجرای روزانه
* حذف:

  * فایل‌های ناقص
  * فایل‌های بلااستفاده
  * فایل‌های قدیمی بدون کاربر

---

### ۶. سیاست Retry

* برای همه Jobها فعال باشد
* الگو:

  * تلاش ۱ → شکست
  * تلاش ۲ → ۵ دقیقه بعد
  * تلاش ۳ → ۱۰ دقیقه بعد
* بعد از اتمام Retry:

  * ذخیره خطا
  * ثبت در لاگ

---

## مثال ورودی/خروجی

### نمونه درخواست ثبت‌نام

```http
POST /api/users/register HTTP/1.1
Content-Type: multipart/form-data
```

### نمونه پاسخ سریع API

```json
{
  "userId": "a1f9c570-0f3b-4d7d-9c35-0a0c12345678",
  "status": "Registered",
  "message": "ثبت‌نام با موفقیت انجام شد."
}
```

### نمونه تایم‌لاین

```
T0      : ثبت‌نام → پاسخ فوری
T0 + 0s : ارسال پیام خوش‌آمدگویی
T0 +30s : شروع پردازش فایل و ساخت PDF
T0 +40s : ارسال پیام تکمیلی
00:00   : اجرای Job پاکسازی شبانه
```

---

## روش اجرا و تست

### ۱) Clone پروژه

```bash
git clone https://github.com/<org>/<repo>.git
cd <repo>
```

### ۲) تنظیمات محیط

* تعیین Hangfire Storage (SQL Server یا Redis)
* تنظیم مسیر ذخیره فایل‌ها

### ۳) Build & Run

```bash
dotnet build
dotnet run
```

### ۴) اجرای تست‌ها

```bash
dotnet test
```

---

## نحوه ارسال (PR)

1. Fork کنید
2. ایجاد Branch:

```bash
git checkout -b solution/<username>
```

3. قرار دادن کد در مسیر:

```
solutions/C#/<username>/
  ├── source
  └── README.md
```

4. ساخت Pull Request با عنوان:

```
[Solution] User Document Background Processing - <username>
```

---

## معیارهای ارزیابی

| معیار               | وزن |
| ------------------- | --- |
| درستی پیاده‌سازی    | 40% |
| کیفیت و خوانایی کد  | 25% |
| Retry و مدیریت خطا  | 10% |
| API و Observability | 10% |
| مستندسازی           | 5%  |
| ارسال زودتر از موعد | 5%  |

---

## زمان‌بندی

* **شروع:** `2025-11-30`
* **ددلاین ارسال PR:** `2025-12-07`

---

## ارتباط

* گروه جامعه دات‌نت / Backend
* یا ایجاد Issue در ریپازیتوری
